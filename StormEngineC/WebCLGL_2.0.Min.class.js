WebCLGLUtils=function(){};WebCLGLUtils.prototype.isPowerOfTwo=function(x){return(x&(x-1))==0;};WebCLGLUtils.prototype.nextHighestPowerOfTwo=function(x){--x;for(var i=1;i<32;i<<=1){x=x|x>>i;}
return x+1;};WebCLGLUtils.prototype.loadQuad=function(node,length,height){var l=(length==undefined)?0.5:length;var h=(height==undefined)?0.5:height;this.vertexArray=[-l,-h,0.0,l,-h,0.0,l,h,0.0,-l,h,0.0];this.textureArray=[0.0,0.0,0.0,1.0,0.0,0.0,1.0,1.0,0.0,0.0,1.0,0.0];this.indexArray=[0,1,2,0,2,3];var meshObject=new Object;meshObject.vertexArray=this.vertexArray;meshObject.vertexItemSize=this.vertexItemSize;meshObject.vertexNumItems=this.vertexNumItems;meshObject.textureArray=this.textureArray;meshObject.textureItemSize=this.textureItemSize;meshObject.textureNumItems=this.textureNumItems;meshObject.indexArray=this.indexArray;meshObject.indexItemSize=this.indexItemSize;meshObject.indexNumItems=this.indexNumItems;return meshObject;};WebCLGLUtils.prototype.getWebGLContextFromCanvas=function(canvas,ctxOpt){var gl;try{if(ctxOpt==undefined)gl=canvas.getContext("webgl");else gl=canvas.getContext("webgl",ctxOpt);}catch(e){gl=null;}
if(gl==null){try{if(ctxOpt==undefined)gl=canvas.getContext("experimental-webgl");else gl=canvas.getContext("experimental-webgl",ctxOpt);}catch(e){gl=null;}}
if(gl==null)gl=false;return gl;};WebCLGLUtils.prototype.createShader=function(gl,name,sourceVertex,sourceFragment,shaderProgram){var _sv=false,_sf=false;var shaderVertex=gl.createShader(gl.VERTEX_SHADER);gl.shaderSource(shaderVertex,sourceVertex);gl.compileShader(shaderVertex);if(!gl.getShaderParameter(shaderVertex,gl.COMPILE_STATUS)){alert('Error sourceVertex of shader '+name+'. See console.');console.log('Error vertex-shader '+name+':\n '+gl.getShaderInfoLog(shaderVertex));if(gl.getShaderInfoLog(shaderVertex)!=undefined){console.log(gl.getShaderInfoLog(shaderVertex));}}else{gl.attachShader(shaderProgram,shaderVertex);_sv=true;}
var shaderFragment=gl.createShader(gl.FRAGMENT_SHADER);gl.shaderSource(shaderFragment,sourceFragment);gl.compileShader(shaderFragment);if(!gl.getShaderParameter(shaderFragment,gl.COMPILE_STATUS)){alert('Error sourceFragment of shader '+name+'. See console.');var infoLog=gl.getShaderInfoLog(shaderFragment);console.log('Error fragment-shader '+name+':\n '+infoLog);if(infoLog!=undefined){console.log(infoLog);var arrErrors=[];var errors=infoLog.split("\n");for(var n=0,f=errors.length;n<f;n++){if(errors[n].match(/^ERROR/gim)!=null){var expl=errors[n].split(':');var line=parseInt(expl[2]);arrErrors.push([line,errors[n]]);}}
var sour=gl.getShaderSource(shaderFragment).split("\n");sour.unshift("");for(var n=0,f=sour.length;n<f;n++){var lineWithError=false;var errorStr='';for(var e=0,fe=arrErrors.length;e<fe;e++){if(n==arrErrors[e][0]){lineWithError=true;errorStr=arrErrors[e][1];break;}}
if(lineWithError==false){console.log(n+' '+sour[n]);}else{console.log('►►'+n+' '+sour[n]+'\n'+errorStr);}}}}else{gl.attachShader(shaderProgram,shaderFragment);_sf=true;}
if(_sv==true&&_sf==true){gl.linkProgram(shaderProgram);if(!gl.getProgramParameter(shaderProgram,gl.LINK_STATUS)){alert('Error in shader '+name);console.log('Error shader program '+name+':\n ');if(gl.getProgramInfoLog(shaderProgram)!=undefined){console.log(gl.getProgramInfoLog(shaderProgram));}
return false;}else{return true;}}else{return false;}};WebCLGLUtils.prototype.getUint8ArrayFromHTMLImageElement=function(imageElement){var e=document.createElement('canvas');e.width=imageElement.width;e.height=imageElement.height;var ctx2D_tex=e.getContext("2d");ctx2D_tex.drawImage(imageElement,0,0);var arrayTex=ctx2D_tex.getImageData(0,0,imageElement.width,imageElement.height);return arrayTex.data;};WebCLGLUtils.prototype.dot4=function(vector4A,vector4B){return vector4A[0]*vector4B[0]+vector4A[1]*vector4B[1]+vector4A[2]*vector4B[2]+vector4A[3]*vector4B[3];};WebCLGLUtils.prototype.fract=function(number){return number-Math.floor(number);};WebCLGLUtils.prototype.pack=function(v){var bias=[1.0/255.0,1.0/255.0,1.0/255.0,0.0];var r=v;var g=this.fract(r*255.0);var b=this.fract(g*255.0);var a=this.fract(b*255.0);var colour=[r,g,b,a];var dd=[colour[1]*bias[0],colour[2]*bias[1],colour[3]*bias[2],colour[3]*bias[3]];return[colour[0]-dd[0],colour[1]-dd[1],colour[2]-dd[2],colour[3]-dd[3]];};WebCLGLUtils.prototype.unpack=function(colour){var bitShifts=[1.0,1.0/255.0,1.0/(255.0*255.0),1.0/(255.0*255.0*255.0)];return this.dot4(colour,bitShifts);};WebCLGLUtils.prototype.packGLSLFunctionString=function(){return'vec4 pack (float depth) {\n'+'const vec4 bias = vec4(1.0 / 255.0,\n'+'1.0 / 255.0,\n'+'1.0 / 255.0,\n'+'0.0);\n'+'float r = depth;\n'+'float g = fract(r * 255.0);\n'+'float b = fract(g * 255.0);\n'+'float a = fract(b * 255.0);\n'+'vec4 colour = vec4(r, g, b, a);\n'+'return colour - (colour.yzww * bias);\n'+'}\n';};WebCLGLUtils.prototype.unpackGLSLFunctionString=function(){return'float unpack (vec4 colour) {\n'+'const vec4 bitShifts = vec4(1.0,\n'+'1.0 / 255.0,\n'+'1.0 / (255.0 * 255.0),\n'+'1.0 / (255.0 * 255.0 * 255.0));\n'+'return dot(colour, bitShifts);\n'+'}\n';};

WebCLGLBuffer=function(gl,length,type,offset,linear,mode,splits){this.gl=gl;this.length=(length instanceof Array)?length[0]*length[1]:length;this.type=type;this.offset=offset;this.linear=linear;this.mode=(mode!=undefined)?mode:"FRAGMENT";this.splits=(splits!=undefined)?splits:[this.length];this.items=[];var countArr=this.length;currItem=0;while(true){if(countArr>this.splits[currItem]){this.items[currItem]=new WebCLGLBufferItem(gl,this.splits[currItem],type,offset,linear,mode);countArr-=this.splits[currItem];}else{this.items[currItem]=new WebCLGLBufferItem(gl,countArr,type,offset,linear,mode);countArr-=countArr;}
if(countArr<=0)break;currItem++;}};WebCLGLBuffer.prototype.writeWebGLTextureBuffer=function(arr,flip){var m=(this.type=="FLOAT4")?4:1;for(var i=0;i<this.items.length;i++){var startItem=(i==0)?0:this.splits[i-1]*m;var endItem=startItem+(this.items[i].length*m);if(this.items.length>1)
this.items[i].writeWebGLTextureBuffer(arr.slice(startItem,endItem),flip);else
this.items[i].writeWebGLTextureBuffer(arr,flip);}};WebCLGLBuffer.prototype.writeWebGLBuffer=function(arr,flip){var m=(this.type=="FLOAT4")?4:1;for(var i=0;i<this.items.length;i++){var startItem=(i==0)?0:this.splits[i-1]*m;var endItem=startItem+(this.items[i].length*m);if(this.items.length>1)
this.items[i].writeWebGLBuffer(arr.slice(startItem,endItem),flip);else
this.items[i].writeWebGLBuffer(arr,flip);}};WebCLGLBuffer.prototype.remove=function(){for(var n=0;n<this.items.length;n++){this.items[n].remove();}};

WebCLGLBufferItem=function(gl,length,type,offset,linear,mode){this.gl=gl;if(length instanceof Object){this.length=length[0]*length[1];this.W=length[0];this.H=length[1];}else{this.length=length;this.W=Math.ceil(Math.sqrt(this.length));this.H=this.W;}
this.utils=new WebCLGLUtils();this.type=(type!=undefined)?type:'FLOAT';this._supportFormat=this.gl.FLOAT;this.offset=(offset!=undefined)?offset:0;this.linear=(linear!=undefined&&linear==true)?true:false;this.inData;this.mode=(mode!=undefined)?mode:"FRAGMENT";this.outArray4Uint8ArrayX=new Uint8Array((this.W*this.H)*4);this.outArray4Uint8ArrayY=new Uint8Array((this.W*this.H)*4);this.outArray4Uint8ArrayZ=new Uint8Array((this.W*this.H)*4);this.outArray4Uint8ArrayW=new Uint8Array((this.W*this.H)*4);this.Packet4Uint8Array_Float=[];this.Float=[];this.Packet4Uint8Array_Float4=[];this.Float4=[];this.rBuffer=this.gl.createRenderbuffer();this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.rBuffer);this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,this.W,this.H);this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null);this.fBuffer=this.gl.createFramebuffer();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fBuffer);this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.rBuffer);if(this.mode=="FRAGMENT"||this.mode=="VERTEX_FROM_KERNEL"||this.mode=="VERTEX_AND_FRAGMENT"){this.textureData=this.createWebGLTextureBuffer();}
if(this.mode=="VERTEX"||this.mode=="VERTEX_INDEX"||this.mode=="VERTEX_FROM_KERNEL"||this.mode=="VERTEX_AND_FRAGMENT"){this.vertexData0=this.createWebGLBuffer();if(this.type=='FLOAT4'){this.vertexData1=this.createWebGLBuffer();this.vertexData2=this.createWebGLBuffer();this.vertexData3=this.createWebGLBuffer();}}};WebCLGLBufferItem.prototype.createWebGLTextureBuffer=function(){this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,false);this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);var textureData=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,textureData);if(this.linear!=undefined&&this.linear==true){this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.W,this.H,0,this.gl.RGBA,this._supportFormat,null);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_NEAREST);this.gl.generateMipmap(this.gl.TEXTURE_2D);}else{this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.W,this.H,0,this.gl.RGBA,this._supportFormat,null);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);}
return textureData;};WebCLGLBufferItem.prototype.createWebGLBuffer=function(){var vertexData=this.gl.createBuffer();return vertexData;};WebCLGLBufferItem.prototype.writeWebGLTextureBuffer=function(arr,flip){this.inData=arr;if(arr instanceof WebGLTexture)this.textureData=arr;else{if(flip==false||flip==undefined)
this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,false);else
this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,true);this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);this.gl.bindTexture(this.gl.TEXTURE_2D,this.textureData);if(arr instanceof HTMLImageElement){this.inData=this.utils.getUint8ArrayFromHTMLImageElement(arr);if(this.type=='FLOAT4'){this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.FLOAT,arr);}}else{if(this.type=='FLOAT4'){var arrt=new Float32Array((this.W*this.H)*4);for(var n=0;n<arr.length;n++)arrt[n]=arr[n];if(arr instanceof Uint8Array){this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.W,this.H,0,this.gl.RGBA,this.gl.FLOAT,arrt);}else if(arr instanceof Float32Array){this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.W,this.H,0,this.gl.RGBA,this.gl.FLOAT,arrt);}else{this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.W,this.H,0,this.gl.RGBA,this.gl.FLOAT,arrt);}}else if(this.type=='FLOAT'){var arrayTemp=new Float32Array(this.W*this.H*4);for(var n=0,f=this.W*this.H;n<f;n++){var idd=n*4;arrayTemp[idd]=arr[n];arrayTemp[idd+1]=0.0;arrayTemp[idd+2]=0.0;arrayTemp[idd+3]=0.0;}
arr=arrayTemp;this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.W,this.H,0,this.gl.RGBA,this.gl.FLOAT,arr);}}}
if(this.linear)this.gl.generateMipmap(this.gl.TEXTURE_2D);};WebCLGLBufferItem.prototype.writeWebGLBuffer=function(arr,flip){this.inData=arr;var makePack=(function(arrr,items){var arOut=[];if(items>1){var arX=new Float32Array(arrr.length/4);var arY=new Float32Array(arrr.length/4);var arZ=new Float32Array(arrr.length/4);var arW=new Float32Array(arrr.length/4);for(var n=0,f=arrr.length/4;n<f;n++){var id=n*4;arX[n]=arrr[id];arY[n]=arrr[id+1];arZ[n]=arrr[id+2];arW[n]=arrr[id+3];}
arOut.push(arX,arY,arZ,arW);}else{arOut.push(arrr);}
var arOutUint=[];for(var i=0,fi=arOut.length;i<fi;i++){var arUint=new Uint8Array(arOut[i].length*4);for(var n=0,f=arOut[i].length;n<f;n++){var idd=n*4;var arrPack=this.utils.pack((arOut[i][n]+(((this.workAreaSize*2.0))/2))/((this.workAreaSize*2.0)));arUint[idd+0]=arrPack[0]*255;arUint[idd+1]=arrPack[1]*255;arUint[idd+2]=arrPack[2]*255;arUint[idd+3]=arrPack[3]*255;}
arOutUint.push(arUint);}
return arOutUint;}).bind(this);if(this.mode=="VERTEX_FROM_KERNEL"){if(this.type=='FLOAT'){var arPack=makePack(arr,1);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexData0);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Uint8Array(arPack[0]),this.gl.DYNAMIC_DRAW);}else if(this.type=='FLOAT4'){var arPack=makePack(arr,4);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexData0);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Uint8Array(arPack[0]),this.gl.DYNAMIC_DRAW);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexData1);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Uint8Array(arPack[1]),this.gl.DYNAMIC_DRAW);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexData2);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Uint8Array(arPack[2]),this.gl.DYNAMIC_DRAW);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexData3);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Uint8Array(arPack[3]),this.gl.DYNAMIC_DRAW);}}else{if(this.mode=="VERTEX_INDEX"){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.vertexData0);this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(arr),this.gl.DYNAMIC_DRAW);}else{this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexData0);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(arr),this.gl.DYNAMIC_DRAW);}}};WebCLGLBufferItem.prototype.remove=function(){this.gl.deleteRenderbuffer(this.rBuffer);this.gl.deleteFramebuffer(this.fBuffer);if(this.mode=="FRAGMENT"||this.mode=="VERTEX_FROM_KERNEL"||this.mode=="VERTEX_AND_FRAGMENT"){this.gl.deleteTexture(this.textureData);}
if(this.mode=="VERTEX"||this.mode=="VERTEX_INDEX"||this.mode=="VERTEX_FROM_KERNEL"||this.mode=="VERTEX_AND_FRAGMENT"){this.gl.deleteBuffer(this.vertexData0);if(this.type=='FLOAT4'){this.gl.deleteBuffer(this.vertexData1);this.gl.deleteBuffer(this.vertexData2);this.gl.deleteBuffer(this.vertexData3);}}};

WebCLGLKernel=function(gl,source,header){this.gl=gl;var highPrecisionSupport=this.gl.getShaderPrecisionFormat(this.gl.FRAGMENT_SHADER,this.gl.HIGH_FLOAT);this.precision=(highPrecisionSupport.precision!=0)?'precision highp float;\n\nprecision highp int;\n\n':'precision lowp float;\n\nprecision lowp int;\n\n';this.utils=new WebCLGLUtils();this.in_values=[];if(source!=undefined)this.setKernelSource(source,header);};WebCLGLKernel.prototype.setKernelSource=function(source,header){this.head=(header!=undefined)?header:'';this.in_values=[];var argumentsSource=source.split(')')[0].split('(')[1].split(',');for(var n=0,f=argumentsSource.length;n<f;n++){if(argumentsSource[n].match(/\*/gm)!=null){if(argumentsSource[n].match(/float4/gm)!=null){this.in_values[n]={value:undefined,type:'buffer_float4',name:argumentsSource[n].split('*')[1].trim()};}else if(argumentsSource[n].match(/float/gm)!=null){this.in_values[n]={value:undefined,type:'buffer_float',name:argumentsSource[n].split('*')[1].trim()};}}else{if(argumentsSource[n].match(/float/gm)!=null){this.in_values[n]={value:undefined,type:'float',name:argumentsSource[n].split(' ')[1].trim()};}}}
this.source=source.replace(/\r\n/gi,'').replace(/\r/gi,'').replace(/\n/gi,'');this.source=this.source.replace(/^\w* \w*\([\w\s\*,]*\) {/gi,'').replace(/}(\s|\t)*$/gi,'');this.source=this.parse(this.source);this.compile();};WebCLGLKernel.prototype.parse=function(source){for(var n=0,f=this.in_values.length;n<f;n++){var regexp=new RegExp(this.in_values[n].name+'\\[\\w*\\]',"gm");var varMatches=source.match(regexp);if(varMatches!=null){for(var nB=0,fB=varMatches.length;nB<fB;nB++){var regexpNativeGL=new RegExp('```(\s|\t)*gl.*'+varMatches[nB]+'.*```[^```(\s|\t)*gl]',"gm");var regexpNativeGLMatches=source.match(regexpNativeGL);if(regexpNativeGLMatches==null){var name=varMatches[nB].split('[')[0];var vari=varMatches[nB].split('[')[1].split(']')[0];var regexp=new RegExp(name+'\\['+vari.trim()+'\\]',"gm");if(this.in_values[n].type=='buffer_float4')
source=source.replace(regexp,'buffer_float4_data('+name+','+vari+')');if(this.in_values[n].type=='buffer_float')
source=source.replace(regexp,'buffer_float_data('+name+','+vari+')');}}}}
source=source.replace(/```(\s|\t)*gl/gi,"").replace(/```/gi,"");return source;};WebCLGLKernel.prototype.compile=function(){lines_attrs=(function(){str='';for(var n=0,f=this.in_values.length;n<f;n++){if(this.in_values[n].type=='buffer_float4'||this.in_values[n].type=='buffer_float'){str+='uniform sampler2D '+this.in_values[n].name+';\n';}else if(this.in_values[n].type=='float'){str+='uniform float '+this.in_values[n].name+';\n';}}
return str;}).bind(this);var sourceVertex=this.precision+'attribute vec3 aVertexPosition;\n'+'attribute vec2 aTextureCoord;\n'+'varying vec2 global_id;\n'+'void main(void) {\n'+'gl_Position = vec4(aVertexPosition, 1.0);\n'+'global_id = aTextureCoord;\n'+'}\n';var sourceFragment=this.precision+
lines_attrs()+'varying vec2 global_id;\n'+'vec4 buffer_float4_data(sampler2D arg, vec2 coord) {\n'+'vec4 textureColor = texture2D(arg, coord);\n'+'return textureColor;\n'+'}\n'+'float buffer_float_data(sampler2D arg, vec2 coord) {\n'+'vec4 textureColor = texture2D(arg, coord);\n'+'return textureColor.x;\n'+'}\n'+'vec2 get_global_id() {\n'+'return global_id;\n'+'}\n'+
this.head+'void main(void) {\n'+'float out_float = -999.99989;\n'+'vec4 out_float4;\n'+
this.source;var sourceFrag=sourceFragment+'if(out_float != -999.99989) gl_FragColor = vec4(out_float,0.0,0.0,1.0);\n'+'else gl_FragColor = out_float4;\n'+'}\n';this.kernelPrograms=[new WebCLGLKernelProgram(this.gl,sourceVertex,sourceFrag,this.in_values)];return true;};WebCLGLKernel.prototype.setKernelArg=function(argument,data){if(data==undefined)alert("Error in setKernelArg("+argument+", data) (this data is undefined)");var numArg;if(typeof argument!="string"){numArg=argument;}else{for(var n=0,fn=this.in_values.length;n<fn;n++){if(this.in_values[n].name==argument){numArg=n;break;}}}
if(this.in_values[numArg]==undefined){console.log("argument "+argument+" not exist in this kernel");return;}
this.in_values[numArg].value=data;for(var n=0,fn=this.kernelPrograms.length;n<fn;n++){var kp=this.kernelPrograms[n];if(this.in_values[numArg].type=='buffer_float4'||this.in_values[numArg].type=='buffer_float'){kp.samplers[this.in_values[numArg].idPointer].value=this.in_values[numArg].value;}else if(this.in_values[numArg].type=='float'){kp.uniforms[this.in_values[numArg].idPointer].value=this.in_values[numArg].value;}}};

WebCLGLKernelProgram=function(gl,sv,sf,in_values){this.gl=gl;this.utils=new WebCLGLUtils();this.kernel=this.gl.createProgram();this.utils.createShader(this.gl,"WEBCLGL",sv,sf,this.kernel);this.samplers=[];this.uniforms=[];this.attr_VertexPos=this.gl.getAttribLocation(this.kernel,"aVertexPosition");this.attr_TextureCoord=this.gl.getAttribLocation(this.kernel,"aTextureCoord");for(var n=0,f=in_values.length;n<f;n++){if(in_values[n].type=='buffer_float4'||in_values[n].type=='buffer_float'){this.samplers.push({location:[this.gl.getUniformLocation(this.kernel,in_values[n].name)],value:in_values[n].value});in_values[n].idPointer=this.samplers.length-1;}else if(in_values[n].type=='float'){this.uniforms.push({location:this.gl.getUniformLocation(this.kernel,in_values[n].name),value:in_values[n].value});in_values[n].idPointer=this.uniforms.length-1;}}};

WebCLGLVertexFragmentProgram=function(gl,vertexSource,vertexHeader,fragmentSource,fragmentHeader){this.gl=gl;var highPrecisionSupport=this.gl.getShaderPrecisionFormat(this.gl.FRAGMENT_SHADER,this.gl.HIGH_FLOAT);this.precision=(highPrecisionSupport.precision!=0)?'precision highp float;\n\nprecision highp int;\n\n':'precision lowp float;\n\nprecision lowp int;\n\n';this.utils=new WebCLGLUtils();this.vertexSource;this.fragmentSource;this.in_vertex_values=[];this.in_fragment_values=[];this.vertexAttributes=[];this.vertexUniforms=[];this.fragmentSamplers=[];this.fragmentUniforms=[];if(vertexSource!=undefined)this.setVertexSource(vertexSource,vertexHeader);if(fragmentSource!=undefined)this.setFragmentSource(fragmentSource,fragmentHeader);};WebCLGLVertexFragmentProgram.prototype.setVertexSource=function(vertexSource,vertexHeader){this.vertexHead=(vertexHeader!=undefined)?vertexHeader:'';this.in_vertex_values=[];var argumentsSource=vertexSource.split(')')[0].split('(')[1].split(',');for(var n=0,f=argumentsSource.length;n<f;n++){if(argumentsSource[n].match(/\*kernel/gm)!=null){if(argumentsSource[n].match(/float4/gm)!=null){this.in_vertex_values[n]={value:undefined,type:'buffer_float4_fromKernel',name:argumentsSource[n].split('*kernel')[1].trim()};}else if(argumentsSource[n].match(/float/gm)!=null){this.in_vertex_values[n]={value:undefined,type:'buffer_float_fromKernel',name:argumentsSource[n].split('*kernel')[1].trim()};}}else if(argumentsSource[n].match(/\*/gm)!=null){if(argumentsSource[n].match(/float4/gm)!=null){this.in_vertex_values[n]={value:undefined,type:'buffer_float4',name:argumentsSource[n].split('*')[1].trim()};}else if(argumentsSource[n].match(/float/gm)!=null){this.in_vertex_values[n]={value:undefined,type:'buffer_float',name:argumentsSource[n].split('*')[1].trim()};}}else{if(argumentsSource[n].match(/float/gm)!=null){this.in_vertex_values[n]={value:undefined,type:'float',name:argumentsSource[n].split(' ')[1].trim()};}else if(argumentsSource[n].match(/mat4/gm)!=null){this.in_vertex_values[n]={value:undefined,type:'mat4',name:argumentsSource[n].split(' ')[1].trim()};}}}
this.vertexSource=vertexSource.replace(/\r\n/gi,'').replace(/\r/gi,'').replace(/\n/gi,'');this.vertexSource=this.vertexSource.replace(/^\w* \w*\([\w\s\*,]*\) {/gi,'').replace(/}(\s|\t)*$/gi,'');this.vertexSource=this.parseVertexSource(this.vertexSource);if(this.fragmentSource!=undefined)this.compileVertexFragmentSource();};WebCLGLVertexFragmentProgram.prototype.parseVertexSource=function(source){for(var n=0,f=this.in_vertex_values.length;n<f;n++){var regexp=new RegExp(this.in_vertex_values[n].name+'\\[\\w*\\]',"gm");var varMatches=source.match(regexp);if(varMatches!=null){for(var nB=0,fB=varMatches.length;nB<fB;nB++){var regexpNativeGL=new RegExp('```(\s|\t)*gl.*'+varMatches[nB]+'.*```[^```(\s|\t)*gl]',"gm");var regexpNativeGLMatches=source.match(regexpNativeGL);if(regexpNativeGLMatches==null){var name=varMatches[nB].split('[')[0];var vari=varMatches[nB].split('[')[1].split(']')[0];var regexp=new RegExp(name+'\\['+vari.trim()+'\\]',"gm");if(this.in_vertex_values[n].type=='buffer_float4_fromKernel')
source=source.replace(regexp,'buffer_float4_fromKernel_data('+name+'0,'+name+'1,'+name+'2,'+name+'3)');if(this.in_vertex_values[n].type=='buffer_float_fromKernel')
source=source.replace(regexp,'buffer_float_fromKernel_data('+name+'0)');if(this.in_vertex_values[n].type=='buffer_float4')
source=source.replace(regexp,name);if(this.in_vertex_values[n].type=='buffer_float')
source=source.replace(regexp,name);}}}}
source=source.replace(/```(\s|\t)*gl/gi,"").replace(/```/gi,"");return source;};WebCLGLVertexFragmentProgram.prototype.setFragmentSource=function(fragmentSource,fragmentHeader){this.fragmentHead=(fragmentHeader!=undefined)?fragmentHeader:'';this.in_fragment_values=[];var argumentsSource=fragmentSource.split(')')[0].split('(')[1].split(',');for(var n=0,f=argumentsSource.length;n<f;n++){if(argumentsSource[n].match(/\*/gm)!=null){if(argumentsSource[n].match(/float4/gm)!=null){this.in_fragment_values[n]={value:undefined,type:'buffer_float4',name:argumentsSource[n].split('*')[1].trim()};}else if(argumentsSource[n].match(/float/gm)!=null){this.in_fragment_values[n]={value:undefined,type:'buffer_float',name:argumentsSource[n].split('*')[1].trim()};}}else{if(argumentsSource[n].match(/float/gm)!=null){this.in_fragment_values[n]={value:undefined,type:'float',name:argumentsSource[n].split(' ')[1].trim()};}}}
this.fragmentSource=fragmentSource.replace(/\r\n/gi,'').replace(/\r/gi,'').replace(/\n/gi,'');this.fragmentSource=this.fragmentSource.replace(/^\w* \w*\([\w\s\*,]*\) {/gi,'').replace(/}(\s|\t)*$/gi,'');this.fragmentSource=this.parseFragmentSource(this.fragmentSource);if(this.vertexSource!=undefined)this.compileVertexFragmentSource();};WebCLGLVertexFragmentProgram.prototype.parseFragmentSource=function(source){for(var n=0,f=this.in_fragment_values.length;n<f;n++){var regexp=new RegExp(this.in_fragment_values[n].name+'\\[\\w*\\]',"gm");var varMatches=source.match(regexp);if(varMatches!=null){for(var nB=0,fB=varMatches.length;nB<fB;nB++){var regexpNativeGL=new RegExp('```(\s|\t)*gl.*'+varMatches[nB]+'.*```[^```(\s|\t)*gl]',"gm");var regexpNativeGLMatches=source.match(regexpNativeGL);if(regexpNativeGLMatches==null){var name=varMatches[nB].split('[')[0];var vari=varMatches[nB].split('[')[1].split(']')[0];var regexp=new RegExp(name+'\\['+vari.trim()+'\\]',"gm");if(this.in_fragment_values[n].type=='buffer_float4')
source=source.replace(regexp,'buffer_float4_data('+name+','+vari+')');if(this.in_fragment_values[n].type=='buffer_float')
source=source.replace(regexp,'buffer_float_data('+name+','+vari+')');}}}}
source=source.replace(/```(\s|\t)*gl/gi,"").replace(/```/gi,"");return source;};WebCLGLVertexFragmentProgram.prototype.compileVertexFragmentSource=function(){lines_vertex_attrs=(function(){str='';for(var n=0,f=this.in_vertex_values.length;n<f;n++){if(this.in_vertex_values[n].type=='buffer_float4_fromKernel'){str+='attribute vec4 '+this.in_vertex_values[n].name+'0;\n';str+='attribute vec4 '+this.in_vertex_values[n].name+'1;\n';str+='attribute vec4 '+this.in_vertex_values[n].name+'2;\n';str+='attribute vec4 '+this.in_vertex_values[n].name+'3;\n';}else if(this.in_vertex_values[n].type=='buffer_float_fromKernel'){str+='attribute vec4 '+this.in_vertex_values[n].name+'0;\n';}else if(this.in_vertex_values[n].type=='buffer_float4'){str+='attribute vec4 '+this.in_vertex_values[n].name+';\n';}else if(this.in_vertex_values[n].type=='buffer_float'){str+='attribute float '+this.in_vertex_values[n].name+';\n';}else if(this.in_vertex_values[n].type=='float'){str+='uniform float '+this.in_vertex_values[n].name+';\n';}else if(this.in_vertex_values[n].type=='mat4'){str+='uniform mat4 '+this.in_vertex_values[n].name+';\n';}}
return str;}).bind(this);lines_fragment_attrs=(function(){str='';for(var n=0,f=this.in_fragment_values.length;n<f;n++){if(this.in_fragment_values[n].type=='buffer_float4'||this.in_fragment_values[n].type=='buffer_float'){str+='uniform sampler2D '+this.in_fragment_values[n].name+';\n';}else if(this.in_fragment_values[n].type=='float'){str+='uniform float '+this.in_fragment_values[n].name+';\n';}}
return str;}).bind(this);var sourceVertex=this.precision+'uniform float uOffset;\n'+
lines_vertex_attrs()+
this.utils.unpackGLSLFunctionString()+'vec4 buffer_float4_fromKernel_data(vec4 arg0, vec4 arg1, vec4 arg2, vec4 arg3) {\n'+'float argX = (unpack(arg0)*(uOffset*2.0))-uOffset;\n'+'float argY = (unpack(arg1)*(uOffset*2.0))-uOffset;\n'+'float argZ = (unpack(arg2)*(uOffset*2.0))-uOffset;\n'+'float argW = (unpack(arg3)*(uOffset*2.0))-uOffset;\n'+'return vec4(argX, argY, argZ, argW);\n'+'}\n'+'float buffer_float_fromKernel_data(vec4 arg0) {\n'+'float argX = (unpack(arg0)*(uOffset*2.0))-uOffset;\n'+'return argX;\n'+'}\n'+'vec2 get_global_id() {\n'+'return vec2(0.0, 0.0);\n'+'}\n'+
this.vertexHead+'void main(void) {\n'+
this.vertexSource+'}\n';var sourceFragment=this.precision+
lines_fragment_attrs()+'vec4 buffer_float4_data(sampler2D arg, vec2 coord) {\n'+'vec4 textureColor = texture2D(arg, coord);\n'+'return textureColor;\n'+'}\n'+'float buffer_float_data(sampler2D arg, vec2 coord) {\n'+'vec4 textureColor = texture2D(arg, coord);\n'+'return textureColor.x;\n'+'}\n'+'vec2 get_global_id() {\n'+'return vec2(0.0, 0.0);\n'+'}\n'+
this.fragmentHead+'void main(void) {\n'+
this.fragmentSource+'}\n';this.vertexFragmentProgram=this.gl.createProgram();this.utils.createShader(this.gl,"WEBCLGL VERTEX FRAGMENT PROGRAM",sourceVertex,sourceFragment,this.vertexFragmentProgram);this.vertexAttributes=[];this.vertexUniforms=[];this.fragmentSamplers=[];this.fragmentUniforms=[];this.uOffset=this.gl.getUniformLocation(this.vertexFragmentProgram,"uOffset");for(var n=0,f=this.in_vertex_values.length;n<f;n++){if(this.in_vertex_values[n].type=='buffer_float4_fromKernel'){this.vertexAttributes.push({location:[this.gl.getAttribLocation(this.vertexFragmentProgram,this.in_vertex_values[n].name+"0"),this.gl.getAttribLocation(this.vertexFragmentProgram,this.in_vertex_values[n].name+"1"),this.gl.getAttribLocation(this.vertexFragmentProgram,this.in_vertex_values[n].name+"2"),this.gl.getAttribLocation(this.vertexFragmentProgram,this.in_vertex_values[n].name+"3")],value:this.in_vertex_values[n].value,type:this.in_vertex_values[n].type});this.in_vertex_values[n].idPointer=this.vertexAttributes.length-1;}else if(this.in_vertex_values[n].type=='buffer_float_fromKernel'){this.vertexAttributes.push({location:[this.gl.getAttribLocation(this.vertexFragmentProgram,this.in_vertex_values[n].name+"0")],value:this.in_vertex_values[n].value,type:this.in_vertex_values[n].type});this.in_vertex_values[n].idPointer=this.vertexAttributes.length-1;}else if(this.in_vertex_values[n].type=='buffer_float4'||this.in_vertex_values[n].type=='buffer_float'){this.vertexAttributes.push({location:[this.gl.getAttribLocation(this.vertexFragmentProgram,this.in_vertex_values[n].name)],value:this.in_vertex_values[n].value,type:this.in_vertex_values[n].type});this.in_vertex_values[n].idPointer=this.vertexAttributes.length-1;}else if(this.in_vertex_values[n].type=='float'||this.in_vertex_values[n].type=='mat4'){this.vertexUniforms.push({location:[this.gl.getUniformLocation(this.vertexFragmentProgram,this.in_vertex_values[n].name)],value:this.in_vertex_values[n].value,type:this.in_vertex_values[n].type});this.in_vertex_values[n].idPointer=this.vertexUniforms.length-1;}}
for(var n=0,f=this.in_fragment_values.length;n<f;n++){if(this.in_fragment_values[n].type=='buffer_float4'||this.in_fragment_values[n].type=='buffer_float'){this.fragmentSamplers.push({location:[this.gl.getUniformLocation(this.vertexFragmentProgram,this.in_fragment_values[n].name)],value:this.in_fragment_values[n].value,type:this.in_fragment_values[n].type});this.in_fragment_values[n].idPointer=this.fragmentSamplers.length-1;}else if(this.in_fragment_values[n].type=='float'){this.fragmentUniforms.push({location:[this.gl.getUniformLocation(this.vertexFragmentProgram,this.in_fragment_values[n].name)],value:this.in_fragment_values[n].value,type:this.in_fragment_values[n].type});this.in_fragment_values[n].idPointer=this.fragmentUniforms.length-1;}}
return true;};WebCLGLVertexFragmentProgram.prototype.setVertexArg=function(argument,data){if(data==undefined)alert("Error: setVertexArg("+argument+", undefined)");var numArg;if(typeof argument!="string"){numArg=argument;}else{for(var n=0,fn=this.in_vertex_values.length;n<fn;n++){if(this.in_vertex_values[n].name==argument){numArg=n;break;}}}
if(this.in_vertex_values[numArg]==undefined){console.log("argument "+argument+" not exist in this vertex program");return;}
this.in_vertex_values[numArg].value=data;if(this.in_vertex_values[numArg].type=='buffer_float4_fromKernel'||this.in_vertex_values[numArg].type=='buffer_float_fromKernel'||this.in_vertex_values[numArg].type=='buffer_float4'||this.in_vertex_values[numArg].type=='buffer_float'){this.vertexAttributes[this.in_vertex_values[numArg].idPointer].value=this.in_vertex_values[numArg].value;}else if(this.in_vertex_values[numArg].type=='float'||this.in_vertex_values[numArg].type=='mat4'){this.vertexUniforms[this.in_vertex_values[numArg].idPointer].value=this.in_vertex_values[numArg].value;}};WebCLGLVertexFragmentProgram.prototype.setFragmentArg=function(argument,data){if(data==undefined)alert("Error: setFragmentArg("+argument+", undefined)");var numArg;if(typeof argument!="string"){numArg=argument;}else{for(var n=0,fn=this.in_fragment_values.length;n<fn;n++){if(this.in_fragment_values[n].name==argument){numArg=n;break;}}}
if(this.in_fragment_values[numArg]==undefined){console.log("argument "+argument+" not exist in this fragment program");return;}
this.in_fragment_values[numArg].value=data;if(this.in_fragment_values[numArg].type=='buffer_float4'||this.in_fragment_values[numArg].type=='buffer_float'){this.fragmentSamplers[this.in_fragment_values[numArg].idPointer].value=this.in_fragment_values[numArg].value;}else if(this.in_fragment_values[numArg].type=='float'){this.fragmentUniforms[this.in_fragment_values[numArg].idPointer].value=this.in_fragment_values[numArg].value;}};

WebCLGL=function(webglcontext){this.utils=new WebCLGLUtils();this.e=undefined;if(webglcontext==undefined){this.e=document.createElement('canvas');this.e.width=32;this.e.height=32;this.gl=this.utils.getWebGLContextFromCanvas(this.e,{antialias:false});}else this.gl=webglcontext;this.gl.getExtension('OES_texture_float');this.gl.getExtension('OES_texture_float_linear');var highPrecisionSupport=this.gl.getShaderPrecisionFormat(this.gl.FRAGMENT_SHADER,this.gl.HIGH_FLOAT);this.precision=(highPrecisionSupport.precision!=0)?'precision highp float;\n\nprecision highp int;\n\n':'precision lowp float;\n\nprecision lowp int;\n\n';var mesh=this.utils.loadQuad(undefined,1.0,1.0);this.vertexBuffer_QUAD=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer_QUAD);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(mesh.vertexArray),this.gl.STATIC_DRAW);this.textureBuffer_QUAD=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureBuffer_QUAD);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(mesh.textureArray),this.gl.STATIC_DRAW);this.indexBuffer_QUAD=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer_QUAD);this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(mesh.indexArray),this.gl.STATIC_DRAW);var sourceVertex=this.precision+'attribute vec3 aVertexPosition;\n'+'attribute vec2 aTextureCoord;\n'+'varying vec2 vTextureCoord;\n'+'void main(void) {\n'+'gl_Position = vec4(aVertexPosition, 1.0);\n'+'vTextureCoord = aTextureCoord;\n'+'}\n';var sourceFragment=this.precision+'uniform sampler2D sampler_buffer;\n'+'uniform int u_vectorValue;\n'+'uniform int u_offset;\n'+'varying vec2 vTextureCoord;\n'+
this.utils.packGLSLFunctionString()+'void main(void) {\n'+'vec4 tex = texture2D(sampler_buffer, vTextureCoord);'+'if(u_offset > 0) {'+'float offset = float(u_offset);'+'if(u_vectorValue == 0) gl_FragColor = pack((tex.r+offset)/(offset*2.0));\n'+'if(u_vectorValue == 1) gl_FragColor = pack((tex.g+offset)/(offset*2.0));\n'+'if(u_vectorValue == 2) gl_FragColor = pack((tex.b+offset)/(offset*2.0));\n'+'if(u_vectorValue == 3) gl_FragColor = pack((tex.a+offset)/(offset*2.0));\n'+'} else {'+'if(u_vectorValue == 0) gl_FragColor = pack(tex.r);\n'+'if(u_vectorValue == 1) gl_FragColor = pack(tex.g);\n'+'if(u_vectorValue == 2) gl_FragColor = pack(tex.b);\n'+'if(u_vectorValue == 3) gl_FragColor = pack(tex.a);\n'+'}'+'}\n';this.shader_readpixels=this.gl.createProgram();this.utils.createShader(this.gl,"CLGLREADPIXELS",sourceVertex,sourceFragment,this.shader_readpixels);this.u_offset=this.gl.getUniformLocation(this.shader_readpixels,"u_offset");this.u_vectorValue=this.gl.getUniformLocation(this.shader_readpixels,"u_vectorValue");this.sampler_buffer=this.gl.getUniformLocation(this.shader_readpixels,"sampler_buffer");this.attr_VertexPos=this.gl.getAttribLocation(this.shader_readpixels,"aVertexPosition");this.attr_TextureCoord=this.gl.getAttribLocation(this.shader_readpixels,"aTextureCoord");var sourceVertex=this.precision+'attribute vec3 aVertexPosition;\n'+'attribute vec2 aTextureCoord;\n'+'varying vec2 vTextureCoord;\n'+'void main(void) {\n'+'gl_Position = vec4(aVertexPosition, 1.0);\n'+'vTextureCoord = aTextureCoord;\n'+'}';var sourceFragment=this.precision+'uniform sampler2D sampler_toSave;\n'+'varying vec2 vTextureCoord;\n'+'void main(void) {\n'+'vec4 texture = texture2D(sampler_toSave, vTextureCoord);\n'+'gl_FragColor = texture;'+'}';this.shader_copyTexture=this.gl.createProgram();this.utils.createShader(this.gl,"CLGLCOPYTEXTURE",sourceVertex,sourceFragment,this.shader_copyTexture);this.attr_copyTexture_pos=this.gl.getAttribLocation(this.shader_copyTexture,"aVertexPosition");this.attr_copyTexture_tex=this.gl.getAttribLocation(this.shader_copyTexture,"aTextureCoord");this.sampler_copyTexture_toSave=this.gl.getUniformLocation(this.shader_copyTexture,"sampler_toSave");};WebCLGL.prototype.copy=function(valuesToRead,valuesToWrite){if(valuesToRead instanceof WebCLGLBuffer){for(var i=0;i<valuesToRead.items.length;i++){valueToRead=valuesToRead.items[i];valueToWrite=valuesToWrite.items[i];this.copyItem(valueToRead,valueToWrite);}}else if(valuesToRead instanceof WebGLTexture)
this.copyItem(valuesToRead,valuesToWrite);};WebCLGL.prototype.copyItem=function(valueToRead,valueToWrite){if(valueToRead instanceof WebCLGLBufferItem){this.gl.viewport(0,0,valueToWrite.W,valueToWrite.H);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,valueToWrite.fBuffer);this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,valueToWrite.textureData,0);}else if(valueToRead instanceof WebGLTexture)
this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,valueToWrite,0);this.gl.useProgram(this.shader_copyTexture);this.gl.activeTexture(this.gl.TEXTURE0);var toRead=(valueToRead instanceof WebGLTexture)?valueToRead:valueToRead.textureData;this.gl.bindTexture(this.gl.TEXTURE_2D,toRead);this.gl.uniform1i(this.sampler_copyTexture_toSave,0);this.gl.enableVertexAttribArray(this.attr_copyTexture_pos);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer_QUAD);this.gl.vertexAttribPointer(this.attr_copyTexture_pos,3,this.gl.FLOAT,false,0,0);this.gl.enableVertexAttribArray(this.attr_copyTexture_tex);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureBuffer_QUAD);this.gl.vertexAttribPointer(this.attr_copyTexture_tex,3,this.gl.FLOAT,false,0,0);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer_QUAD);this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_SHORT,0);};WebCLGL.prototype.createBuffer=function(length,type,offset,linear,mode,splits){return new WebCLGLBuffer(this.gl,length,type,offset,linear,mode,splits);};WebCLGL.prototype.createKernel=function(source,header){var webclglKernel=new WebCLGLKernel(this.gl,source,header);return webclglKernel;};WebCLGL.prototype.createVertexFragmentProgram=function(vertexSource,vertexHeader,fragmentSource,fragmentHeader){var webclglVertexFragmentProgram=new WebCLGLVertexFragmentProgram(this.gl,vertexSource,vertexHeader,fragmentSource,fragmentHeader);return webclglVertexFragmentProgram;};WebCLGL.prototype.enqueueWriteBuffer=function(buffer,arr,flip){if(buffer.mode=="FRAGMENT"||buffer.mode=="VERTEX_FROM_KERNEL"||buffer.mode=="VERTEX_AND_FRAGMENT"){buffer.writeWebGLTextureBuffer(arr,flip);}
if(buffer.mode=="VERTEX"||buffer.mode=="VERTEX_INDEX"||buffer.mode=="VERTEX_FROM_KERNEL"||buffer.mode=="VERTEX_AND_FRAGMENT"){buffer.writeWebGLBuffer(arr,flip);}};WebCLGL.prototype.enqueueNDRangeKernel=function(webCLGLKernel,webCLGLBuffers){for(var i=0;i<webCLGLBuffers.items.length;i++){webCLGLBuffer=webCLGLBuffers.items[i];this.gl.viewport(0,0,webCLGLBuffer.W,webCLGLBuffer.H);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,webCLGLBuffer.fBuffer);this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,webCLGLBuffer.textureData,0);var kp=webCLGLKernel.kernelPrograms[0];this.gl.useProgram(kp.kernel);var currentTextureUnit=0;for(var n=0,f=kp.samplers.length;n<f;n++){if(currentTextureUnit<16)
this.gl.activeTexture(this.gl["TEXTURE"+currentTextureUnit]);else
this.gl.activeTexture(this.gl["TEXTURE16"]);this.gl.bindTexture(this.gl.TEXTURE_2D,kp.samplers[n].value.items[i].textureData);this.gl.uniform1i(kp.samplers[n].location[0],currentTextureUnit);currentTextureUnit++;}
for(var n=0,f=kp.uniforms.length;n<f;n++)
this.gl.uniform1f(kp.uniforms[n].location,kp.uniforms[n].value);this.gl.enableVertexAttribArray(kp.attr_VertexPos);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer_QUAD);this.gl.vertexAttribPointer(kp.attr_VertexPos,3,webCLGLBuffer._supportFormat,false,0,0);this.gl.enableVertexAttribArray(kp.attr_TextureCoord);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureBuffer_QUAD);this.gl.vertexAttribPointer(kp.attr_TextureCoord,3,webCLGLBuffer._supportFormat,false,0,0);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer_QUAD);this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_SHORT,0);}};WebCLGL.prototype.enqueueVertexFragmentProgram=function(webCLGLVertexFragmentProgram,buffer,drawMode){var Dmode=(drawMode!=undefined)?drawMode:4;this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);this.gl.useProgram(webCLGLVertexFragmentProgram.vertexFragmentProgram);for(var i=0;i<webCLGLVertexFragmentProgram.vertexAttributes[0].value.items.length;i++){var bufferItem=webCLGLVertexFragmentProgram.vertexAttributes[0].value.items[i];var currentTextureUnit=0;for(var n=0,f=webCLGLVertexFragmentProgram.fragmentSamplers.length;n<f;n++){if(currentTextureUnit<16)
this.gl.activeTexture(this.gl["TEXTURE"+currentTextureUnit]);else
this.gl.activeTexture(this.gl["TEXTURE16"]);this.gl.bindTexture(this.gl.TEXTURE_2D,webCLGLVertexFragmentProgram.fragmentSamplers[n].value.items[i].textureData);this.gl.uniform1i(webCLGLVertexFragmentProgram.fragmentSamplers[n].location[0],currentTextureUnit);currentTextureUnit++;}
for(var n=0,f=webCLGLVertexFragmentProgram.fragmentUniforms.length;n<f;n++){this.gl.uniform1f(webCLGLVertexFragmentProgram.fragmentUniforms[n].location[0],webCLGLVertexFragmentProgram.fragmentUniforms[n].value);}
this.gl.uniform1f(webCLGLVertexFragmentProgram.uOffset,bufferItem.offset);for(var n=0,f=webCLGLVertexFragmentProgram.vertexAttributes.length;n<f;n++){if(webCLGLVertexFragmentProgram.vertexAttributes[n].type=='buffer_float4_fromKernel'){this.gl.enableVertexAttribArray(webCLGLVertexFragmentProgram.vertexAttributes[n].location[0]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,webCLGLVertexFragmentProgram.vertexAttributes[n].value.items[i].vertexData0);this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,webCLGLVertexFragmentProgram.vertexAttributes[n].value.items[i].Packet4Uint8Array_Float4[0]);this.gl.vertexAttribPointer(webCLGLVertexFragmentProgram.vertexAttributes[n].location[0],4,this.gl.UNSIGNED_BYTE,true,0,0);this.gl.enableVertexAttribArray(webCLGLVertexFragmentProgram.vertexAttributes[n].location[1]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,webCLGLVertexFragmentProgram.vertexAttributes[n].value.items[i].vertexData1);this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,webCLGLVertexFragmentProgram.vertexAttributes[n].value.items[i].Packet4Uint8Array_Float4[1]);this.gl.vertexAttribPointer(webCLGLVertexFragmentProgram.vertexAttributes[n].location[1],4,this.gl.UNSIGNED_BYTE,true,0,0);this.gl.enableVertexAttribArray(webCLGLVertexFragmentProgram.vertexAttributes[n].location[2]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,webCLGLVertexFragmentProgram.vertexAttributes[n].value.items[i].vertexData2);this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,webCLGLVertexFragmentProgram.vertexAttributes[n].value.items[i].Packet4Uint8Array_Float4[2]);this.gl.vertexAttribPointer(webCLGLVertexFragmentProgram.vertexAttributes[n].location[2],4,this.gl.UNSIGNED_BYTE,true,0,0);this.gl.enableVertexAttribArray(webCLGLVertexFragmentProgram.vertexAttributes[n].location[3]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,webCLGLVertexFragmentProgram.vertexAttributes[n].value.items[i].vertexData3);this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,webCLGLVertexFragmentProgram.vertexAttributes[n].value.items[i].Packet4Uint8Array_Float4[3]);this.gl.vertexAttribPointer(webCLGLVertexFragmentProgram.vertexAttributes[n].location[3],4,this.gl.UNSIGNED_BYTE,true,0,0);}else if(webCLGLVertexFragmentProgram.vertexAttributes[n].type=='buffer_float_fromKernel'){this.gl.enableVertexAttribArray(webCLGLVertexFragmentProgram.vertexAttributes[n].location[0]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,webCLGLVertexFragmentProgram.vertexAttributes[n].value.items[i].vertexData0);this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,webCLGLVertexFragmentProgram.vertexAttributes[n].value.items[i].Packet4Uint8Array_Float[0]);this.gl.vertexAttribPointer(webCLGLVertexFragmentProgram.vertexAttributes[n].location[0],4,this.gl.UNSIGNED_BYTE,true,0,0);}else if(webCLGLVertexFragmentProgram.vertexAttributes[n].type=='buffer_float4'){this.gl.enableVertexAttribArray(webCLGLVertexFragmentProgram.vertexAttributes[n].location[0]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,webCLGLVertexFragmentProgram.vertexAttributes[n].value.items[i].vertexData0);this.gl.vertexAttribPointer(webCLGLVertexFragmentProgram.vertexAttributes[n].location[0],4,this.gl.FLOAT,false,0,0);}else if(webCLGLVertexFragmentProgram.vertexAttributes[n].type=='buffer_float'){this.gl.enableVertexAttribArray(webCLGLVertexFragmentProgram.vertexAttributes[n].location[0]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,webCLGLVertexFragmentProgram.vertexAttributes[n].value.items[i].vertexData0);this.gl.vertexAttribPointer(webCLGLVertexFragmentProgram.vertexAttributes[n].location[0],1,this.gl.FLOAT,false,0,0);}}
for(var n=0,f=webCLGLVertexFragmentProgram.vertexUniforms.length;n<f;n++){if(webCLGLVertexFragmentProgram.vertexUniforms[n].type=='float'){this.gl.uniform1f(webCLGLVertexFragmentProgram.vertexUniforms[n].location[0],webCLGLVertexFragmentProgram.vertexUniforms[n].value);}else if(webCLGLVertexFragmentProgram.vertexUniforms[n].type=='mat4'){this.gl.uniformMatrix4fv(webCLGLVertexFragmentProgram.vertexUniforms[n].location[0],false,webCLGLVertexFragmentProgram.vertexUniforms[n].value);}}
if(buffer.mode=="VERTEX_INDEX"){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,buffer.items[i].vertexData0);this.gl.drawElements(Dmode,buffer.items[i].length,this.gl.UNSIGNED_SHORT,0);}else{this.gl.drawArrays(Dmode,0,buffer.items[i].length);}}};WebCLGL.prototype.enqueueReadBuffer_WebGLTexture=function(buffer){return buffer.items[0].textureData;};WebCLGL.prototype.enqueueReadBuffer=function(buffer,item){this.gl.uniform1i(this.u_vectorValue,item);this.gl.uniform1i(this.u_offset,buffer.offset);this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,buffer.textureData);this.gl.uniform1i(this.sampler_buffer,0);this.gl.enableVertexAttribArray(this.attr_VertexPos);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer_QUAD);this.gl.vertexAttribPointer(this.attr_VertexPos,3,buffer._supportFormat,false,0,0);this.gl.enableVertexAttribArray(this.attr_TextureCoord);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureBuffer_QUAD);this.gl.vertexAttribPointer(this.attr_TextureCoord,3,buffer._supportFormat,false,0,0);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer_QUAD);this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_SHORT,0);var arrLength=buffer.length*4;if(item==0){this.gl.readPixels(0,0,buffer.W,buffer.H,this.gl.RGBA,this.gl.UNSIGNED_BYTE,buffer.outArray4Uint8ArrayX);return buffer.outArray4Uint8ArrayX.slice(0,arrLength);}else if(item==1){this.gl.readPixels(0,0,buffer.W,buffer.H,this.gl.RGBA,this.gl.UNSIGNED_BYTE,buffer.outArray4Uint8ArrayY);return buffer.outArray4Uint8ArrayY.slice(0,arrLength);}else if(item==2){this.gl.readPixels(0,0,buffer.W,buffer.H,this.gl.RGBA,this.gl.UNSIGNED_BYTE,buffer.outArray4Uint8ArrayZ);return buffer.outArray4Uint8ArrayZ.slice(0,arrLength);}else if(item==3){this.gl.readPixels(0,0,buffer.W,buffer.H,this.gl.RGBA,this.gl.UNSIGNED_BYTE,buffer.outArray4Uint8ArrayW);return buffer.outArray4Uint8ArrayW.slice(0,arrLength);}};WebCLGL.prototype.prepareViewportForBufferRead=function(buffer){this.gl.viewport(0,0,buffer.W,buffer.H);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);if(this.e!=undefined){this.e.width=buffer.W;this.e.height=buffer.H;}};WebCLGL.prototype.enqueueReadBuffer_Packet4Uint8Array_Float4=function(buffers){if(buffers.items[0].type=="FLOAT4"){for(var i=0;i<buffers.items.length;i++){buffer=buffers.items[i];this.prepareViewportForBufferRead(buffer);this.gl.useProgram(this.shader_readpixels);buffer.Packet4Uint8Array_Float4=[this.enqueueReadBuffer(buffer,0),this.enqueueReadBuffer(buffer,1),this.enqueueReadBuffer(buffer,2),this.enqueueReadBuffer(buffer,3)];}}};WebCLGL.prototype.enqueueReadBuffer_Float4=function(buffers){var Float4_Un=[[],[],[],[]];if(buffers.items[0].type=="FLOAT4"){for(var i=0;i<buffers.items.length;i++){buffer=buffers.items[i];this.prepareViewportForBufferRead(buffer);this.gl.useProgram(this.shader_readpixels);buffer.Packet4Uint8Array_Float4=[this.enqueueReadBuffer(buffer,0),this.enqueueReadBuffer(buffer,1),this.enqueueReadBuffer(buffer,2),this.enqueueReadBuffer(buffer,3)];buffer.Float4=[];for(var n=0,fn=4;n<fn;n++){var arr=buffer.Packet4Uint8Array_Float4[n];var outArrayFloat32Array=new Float32Array((buffer.W*buffer.H));for(var nb=0,fnb=arr.length/4;nb<fnb;nb++){var idd=nb*4;if(buffer.offset>0)outArrayFloat32Array[nb]=(this.utils.unpack([arr[idd+0]/255,arr[idd+1]/255,arr[idd+2]/255,arr[idd+3]/255])*(buffer.offset*2))-buffer.offset;else outArrayFloat32Array[nb]=(this.utils.unpack([arr[idd+0]/255,arr[idd+1]/255,arr[idd+2]/255,arr[idd+3]/255]));Float4_Un[n].push(outArrayFloat32Array[nb]);}
buffer.Float4.push(outArrayFloat32Array.slice(0,buffer.length));}}}
return Float4_Un;};WebCLGL.prototype.enqueueReadBuffer_Packet4Uint8Array_Float=function(buffers){if(buffers.items[0].type=="FLOAT"){for(var i=0;i<buffers.items.length;i++){buffer=buffers.items[i];this.prepareViewportForBufferRead(buffer);this.gl.useProgram(this.shader_readpixels);buffer.Packet4Uint8Array_Float=[this.enqueueReadBuffer(buffer,0)];}}};WebCLGL.prototype.enqueueReadBuffer_Float=function(buffers){var Float_Un=[[]];if(buffers.items[0].type=="FLOAT"){for(var i=0;i<buffers.items.length;i++){buffer=buffers.items[i];this.prepareViewportForBufferRead(buffer);this.gl.useProgram(this.shader_readpixels);buffer.Packet4Uint8Array_Float=[this.enqueueReadBuffer(buffer,0)];buffer.Float=[];for(var n=0,fn=1;n<fn;n++){var arr=buffer.Packet4Uint8Array_Float[n];var outArrayFloat32Array=new Float32Array((buffer.W*buffer.H));for(var nb=0,fnb=arr.length/4;nb<fnb;nb++){var idd=nb*4;if(buffer.offset>0)outArrayFloat32Array[nb]=(this.utils.unpack([arr[idd+0]/255,arr[idd+1]/255,arr[idd+2]/255,arr[idd+3]/255])*(buffer.offset*2))-buffer.offset;else outArrayFloat32Array[nb]=(this.utils.unpack([arr[idd+0]/255,arr[idd+1]/255,arr[idd+2]/255,arr[idd+3]/255]));Float_Un[n].push(outArrayFloat32Array[nb]);}
buffer.Float.push(outArrayFloat32Array.slice(0,buffer.length));}}}
return Float_Un;};