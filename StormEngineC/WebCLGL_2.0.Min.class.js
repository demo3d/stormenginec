WebCLGLUtils=function(gl){this.gl=gl;};WebCLGLUtils.prototype.isPowerOfTwo=function(x){return(x&(x-1))==0;};WebCLGLUtils.prototype.nextHighestPowerOfTwo=function(x){--x;for(var i=1;i<32;i<<=1){x=x|x>>i;}
return x+1;};WebCLGLUtils.prototype.loadQuad=function(node,length,height){var l=(length==undefined)?0.5:length;var h=(height==undefined)?0.5:height;this.vertexArray=[-l,-h,0.0,l,-h,0.0,l,h,0.0,-l,h,0.0];this.textureArray=[0.0,0.0,0.0,1.0,0.0,0.0,1.0,1.0,0.0,0.0,1.0,0.0];this.indexArray=[0,1,2,0,2,3];var meshObject=new Object;meshObject.vertexArray=this.vertexArray;meshObject.vertexItemSize=this.vertexItemSize;meshObject.vertexNumItems=this.vertexNumItems;meshObject.textureArray=this.textureArray;meshObject.textureItemSize=this.textureItemSize;meshObject.textureNumItems=this.textureNumItems;meshObject.indexArray=this.indexArray;meshObject.indexItemSize=this.indexItemSize;meshObject.indexNumItems=this.indexNumItems;return meshObject;};WebCLGLUtils.prototype.createShader=function(name,sourceVertex,sourceFragment,shaderProgram){var _sv=false,_sf=false;var shaderVertex=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(shaderVertex,sourceVertex);this.gl.compileShader(shaderVertex);if(!this.gl.getShaderParameter(shaderVertex,this.gl.COMPILE_STATUS)){alert('Error sourceVertex of shader '+name+'. See console.');console.log('Error vertex-shader '+name+':\n '+this.gl.getShaderInfoLog(shaderVertex));if(this.gl.getShaderInfoLog(shaderVertex)!=undefined){console.log(this.gl.getShaderInfoLog(shaderVertex));}}else{this.gl.attachShader(shaderProgram,shaderVertex);_sv=true;}
var shaderFragment=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(shaderFragment,sourceFragment);this.gl.compileShader(shaderFragment);if(!this.gl.getShaderParameter(shaderFragment,this.gl.COMPILE_STATUS)){alert('Error sourceFragment of shader '+name+'. See console.');var infoLog=this.gl.getShaderInfoLog(shaderFragment);console.log('Error fragment-shader '+name+':\n '+infoLog);if(infoLog!=undefined){console.log(infoLog);var arrErrors=[];var errors=infoLog.split("\n");for(var n=0,f=errors.length;n<f;n++){if(errors[n].match(/^ERROR/gim)!=null){var expl=errors[n].split(':');var line=parseInt(expl[2]);arrErrors.push([line,errors[n]]);}}
var sour=this.gl.getShaderSource(shaderFragment).split("\n");sour.unshift("");for(var n=0,f=sour.length;n<f;n++){var lineWithError=false;var errorStr='';for(var e=0,fe=arrErrors.length;e<fe;e++){if(n==arrErrors[e][0]){lineWithError=true;errorStr=arrErrors[e][1];break;}}
if(lineWithError==false){console.log(n+' '+sour[n]);}else{console.log('►►'+n+' '+sour[n]+'\n'+errorStr);}}}}else{this.gl.attachShader(shaderProgram,shaderFragment);_sf=true;}
if(_sv==true&&_sf==true){this.gl.linkProgram(shaderProgram);if(!this.gl.getProgramParameter(shaderProgram,this.gl.LINK_STATUS)){alert('Error in shader '+name);console.log('Error shader program '+name+':\n ');if(this.gl.getProgramInfoLog(shaderProgram)!=undefined){console.log(this.gl.getProgramInfoLog(shaderProgram));}
return false;}else{return true;}}else{return false;}};WebCLGLUtils.prototype.getUint8ArrayFromHTMLImageElement=function(imageElement){var e=document.createElement('canvas');e.width=imageElement.width;e.height=imageElement.height;var ctx2D_tex=e.getContext("2d");ctx2D_tex.drawImage(imageElement,0,0);var arrayTex=ctx2D_tex.getImageData(0,0,imageElement.width,imageElement.height);return arrayTex.data;};WebCLGLUtils.prototype.dot4=function(vector4A,vector4B){return vector4A[0]*vector4B[0]+vector4A[1]*vector4B[1]+vector4A[2]*vector4B[2]+vector4A[3]*vector4B[3];};WebCLGLUtils.prototype.fract=function(number){return number-Math.floor(number);};WebCLGLUtils.prototype.pack=function(v){var bias=[1.0/255.0,1.0/255.0,1.0/255.0,0.0];var r=v;var g=this.fract(r*255.0);var b=this.fract(g*255.0);var a=this.fract(b*255.0);var colour=[r,g,b,a];var dd=[colour[1]*bias[0],colour[2]*bias[1],colour[3]*bias[2],colour[3]*bias[3]];return[colour[0]-dd[0],colour[1]-dd[1],colour[2]-dd[2],colour[3]-dd[3]];};WebCLGLUtils.prototype.unpack=function(colour){var bitShifts=[1.0,1.0/255.0,1.0/(255.0*255.0),1.0/(255.0*255.0*255.0)];return this.dot4(colour,bitShifts);};WebCLGLUtils.prototype.packGLSLFunctionString=function(){return'vec4 pack (float depth) {'+'const vec4 bias = vec4(1.0 / 255.0,'+'1.0 / 255.0,'+'1.0 / 255.0,'+'0.0);'+'float r = depth;'+'float g = fract(r * 255.0);'+'float b = fract(g * 255.0);'+'float a = fract(b * 255.0);'+'vec4 colour = vec4(r, g, b, a);'+'return colour - (colour.yzww * bias);'+'}';};WebCLGLUtils.prototype.unpackGLSLFunctionString=function(){return'float unpack (vec4 colour) {'+'const vec4 bitShifts = vec4(1.0,'+'1.0 / 255.0,'+'1.0 / (255.0 * 255.0),'+'1.0 / (255.0 * 255.0 * 255.0));'+'return dot(colour, bitShifts);'+'}';};

WebCLGLBuffer=function(gl,length,type,offset,linear){this.gl=gl;if(length instanceof Object){this.length=length[0]*length[1];this.W=length[0];this.H=length[1];}else{this.length=length;this.W=Math.ceil(Math.sqrt(this.length));this.H=this.W;}
this.type=(type!=undefined)?type:'FLOAT';this._supportFormat=this.gl.FLOAT;this.offset=(offset!=undefined)?offset:0;this.linear=(linear!=undefined&&linear==true)?true:false;this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,false);this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);this.textureData=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,this.textureData);if(this.linear!=undefined&&this.linear==true){this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.W,this.H,0,this.gl.RGBA,this._supportFormat,null);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_NEAREST);this.gl.generateMipmap(this.gl.TEXTURE_2D);}else{this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.W,this.H,0,this.gl.RGBA,this._supportFormat,null);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);}
this.inData;this.outArray4Uint8ArrayX=new Uint8Array((this.W*this.H)*4);this.outArray4Uint8ArrayY=new Uint8Array((this.W*this.H)*4);this.outArray4Uint8ArrayZ=new Uint8Array((this.W*this.H)*4);this.outArray4Uint8ArrayW=new Uint8Array((this.W*this.H)*4);this.outArrayFloat32ArrayX=new Float32Array((this.W*this.H)*4);this.rBuffer=this.gl.createRenderbuffer();this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.rBuffer);this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,this.W,this.H);this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null);this.fBuffer=this.gl.createFramebuffer();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fBuffer);this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.rBuffer);};WebCLGLBuffer.prototype.remove=function(){this.gl.deleteTexture(this.textureData);this.gl.deleteRenderbuffer(this.rBuffer);this.gl.deleteFramebuffer(this.fBuffer);};

WebCLGLKernel=function(gl,source,header){this.gl=gl;var highPrecisionSupport=this.gl.getShaderPrecisionFormat(this.gl.FRAGMENT_SHADER,this.gl.HIGH_FLOAT);this.precision=(highPrecisionSupport.precision!=0)?'precision highp float;\n\nprecision highp int;\n\n':'precision lowp float;\n\nprecision lowp int;\n\n';this.utils=new WebCLGLUtils(this.gl);this.in_values=[];if(source!=undefined)this.setKernelSource(source,header);};WebCLGLKernel.prototype.setKernelSource=function(source,header){this.head=(header!=undefined)?header:'';this.in_values=[];var argumentsSource=source.split(')')[0].split('(')[1].split(',');for(var n=0,f=argumentsSource.length;n<f;n++){if(argumentsSource[n].match(/\*/gm)!=null){if(argumentsSource[n].match(/float4/gm)!=null){this.in_values[n]={value:undefined,type:'buffer_float4',name:argumentsSource[n].split('*')[1].trim()};}else if(argumentsSource[n].match(/float/gm)!=null){this.in_values[n]={value:undefined,type:'buffer_float',name:argumentsSource[n].split('*')[1].trim()};}}else{if(argumentsSource[n].match(/float/gm)!=null){this.in_values[n]={value:undefined,type:'float',name:argumentsSource[n].split(' ')[1].trim()};}}}
this.source=source.replace(/\r\n/gi,'').replace(/\r/gi,'').replace(/\n/gi,'');this.source=this.source.replace(/^\w* \w*\([\w\s\*,]*\) {/gi,'').replace(/}(\s|\t)*$/gi,'');this.source=this.parse(this.source);this.compile();};WebCLGLKernel.prototype.parse=function(source){for(var n=0,f=this.in_values.length;n<f;n++){var regexp=new RegExp(this.in_values[n].name+'\\[\\w*\\]',"gm");var varMatches=source.match(regexp);if(varMatches!=null){for(var nB=0,fB=varMatches.length;nB<fB;nB++){var regexpNativeGL=new RegExp('```(\s|\t)*gl.*'+varMatches[nB]+'.*```[^```(\s|\t)*gl]',"gm");var regexpNativeGLMatches=source.match(regexpNativeGL);if(regexpNativeGLMatches==null){var name=varMatches[nB].split('[')[0];var vari=varMatches[nB].split('[')[1].split(']')[0];var regexp=new RegExp(name+'\\['+vari.trim()+'\\]',"gm");if(this.in_values[n].type=='buffer_float4')
source=source.replace(regexp,'buffer_float4_data('+name+','+vari+')');if(this.in_values[n].type=='buffer_float')
source=source.replace(regexp,'buffer_float_data('+name+','+vari+')');}}}}
source=source.replace(/```(\s|\t)*gl/gi,"").replace(/```/gi,"");return source;};WebCLGLKernel.prototype.compile=function(){lines_attrs=(function(){str='';for(var n=0,f=this.in_values.length;n<f;n++){if(this.in_values[n].type=='buffer_float4'||this.in_values[n].type=='buffer_float'){str+='uniform sampler2D '+this.in_values[n].name+';\n';}else if(this.in_values[n].type=='float'){str+='uniform float '+this.in_values[n].name+';\n';}}
return str;}).bind(this);var sourceVertex=this.precision+'attribute vec3 aVertexPosition;\n'+'attribute vec2 aTextureCoord;\n'+'varying vec2 global_id;\n'+'void main(void) {\n'+'gl_Position = vec4(aVertexPosition, 1.0);\n'+'global_id = aTextureCoord;\n'+'}\n';var sourceFragment=this.precision+
lines_attrs()+
this.utils.unpackGLSLFunctionString()+'varying vec2 global_id;\n'+'vec4 buffer_float4_data(sampler2D arg, vec2 coord) {\n'+'vec4 textureColor = texture2D(arg, coord);\n'+'return textureColor;\n'+'}\n'+'float buffer_float_data(sampler2D arg, vec2 coord) {\n'+'vec4 textureColor = texture2D(arg, coord);\n'+'return textureColor.x;\n'+'}\n'+'vec2 get_global_id() {\n'+'return global_id;\n'+'}\n'+
this.head+'void main(void) {\n'+'float out_float = -999.99989;\n'+'vec4 out_float4;\n'+
this.source;var sourceFrag=sourceFragment+'if(out_float != -999.99989) gl_FragColor = vec4(out_float,0.0,0.0,1.0);\n'+'else gl_FragColor = out_float4;\n'+'}\n';this.kernelPrograms=[new WebCLGLKernelProgram(this.gl,sourceVertex,sourceFrag,this.in_values)];return true;};WebCLGLKernel.prototype.setKernelArg=function(argument,data){if(data==undefined)alert("Error in setKernelArg("+argument+", data) (this data is undefined)");var numArg;if(typeof argument!="string"){numArg=argument;}else{for(var n=0,fn=this.in_values.length;n<fn;n++){if(this.in_values[n].name==argument){numArg=n;break;}}}
if(this.in_values[numArg]==undefined){console.log("argument "+argument+" not exist in this kernel");return;}
this.in_values[numArg].value=data;for(var n=0,fn=this.kernelPrograms.length;n<fn;n++){var kp=this.kernelPrograms[n];if(this.in_values[numArg].type=='buffer_float4'||this.in_values[numArg].type=='buffer_float'){kp.samplers[this.in_values[numArg].idPointer].value=this.in_values[numArg].value;}else if(this.in_values[numArg].type=='float'){kp.uniforms[this.in_values[numArg].idPointer].value=this.in_values[numArg].value;}}};

WebCLGLKernelProgram=function(gl,sv,sf,in_values){this.gl=gl;this.utils=new WebCLGLUtils(this.gl);this.kernel=this.gl.createProgram();this.utils.createShader("WEBCLGL",sv,sf,this.kernel);this.samplers=[];this.uniforms=[];this.attr_VertexPos=this.gl.getAttribLocation(this.kernel,"aVertexPosition");this.attr_TextureCoord=this.gl.getAttribLocation(this.kernel,"aTextureCoord");for(var n=0,f=in_values.length;n<f;n++){if(in_values[n].type=='buffer_float4'||in_values[n].type=='buffer_float'){this.samplers.push({location:[this.gl.getUniformLocation(this.kernel,in_values[n].name)],value:in_values[n].value});in_values[n].idPointer=this.samplers.length-1;}else if(in_values[n].type=='float'){this.uniforms.push({location:this.gl.getUniformLocation(this.kernel,in_values[n].name),value:in_values[n].value});in_values[n].idPointer=this.uniforms.length-1;}}};

WebCLGL=function(webglcontext){this.e=undefined;if(webglcontext==undefined){this.e=document.createElement('canvas');this.e.width=32;this.e.height=32;try{this.gl=this.e.getContext("webgl",{antialias:false});}catch(e){this.gl=undefined;}
if(this.gl==undefined){try{this.gl=this.e.getContext("experimental-webgl",{antialias:false});}catch(e){this.gl=undefined;}}}else this.gl=webglcontext;this.gl.getExtension('OES_texture_float');this.gl.getExtension('OES_texture_float_linear');var highPrecisionSupport=this.gl.getShaderPrecisionFormat(this.gl.FRAGMENT_SHADER,this.gl.HIGH_FLOAT);this.precision=(highPrecisionSupport.precision!=0)?'precision highp float;\n\nprecision highp int;\n\n':'precision lowp float;\n\nprecision lowp int;\n\n';this.gl.viewport(0,0,32,32);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);this.utils=new WebCLGLUtils(this.gl);var mesh=this.utils.loadQuad(undefined,1.0,1.0);this.vertexBuffer_QUAD=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer_QUAD);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(mesh.vertexArray),this.gl.STATIC_DRAW);this.textureBuffer_QUAD=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureBuffer_QUAD);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(mesh.textureArray),this.gl.STATIC_DRAW);this.indexBuffer_QUAD=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer_QUAD);this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(mesh.indexArray),this.gl.STATIC_DRAW);var sourceVertex=this.precision+'attribute vec3 aVertexPosition;\n'+'attribute vec2 aTextureCoord;\n'+'varying vec2 vTextureCoord;\n'+'void main(void) {\n'+'gl_Position = vec4(aVertexPosition, 1.0);\n'+'vTextureCoord = aTextureCoord;\n'+'}\n';var sourceFragment=this.precision+'uniform sampler2D sampler_buffer;\n'+'uniform int u_vectorValue;\n'+'uniform int u_offset;\n'+'varying vec2 vTextureCoord;\n'+
this.utils.packGLSLFunctionString()+'void main(void) {\n'+'vec4 tex = texture2D(sampler_buffer, vTextureCoord);'+'if(u_offset > 0) {'+'float offset = float(u_offset);'+'if(u_vectorValue == 0) gl_FragColor = pack((tex.r+offset)/(offset*2.0));\n'+'if(u_vectorValue == 1) gl_FragColor = pack((tex.g+offset)/(offset*2.0));\n'+'if(u_vectorValue == 2) gl_FragColor = pack((tex.b+offset)/(offset*2.0));\n'+'if(u_vectorValue == 3) gl_FragColor = pack((tex.a+offset)/(offset*2.0));\n'+'} else {'+'if(u_vectorValue == 0) gl_FragColor = pack(tex.r);\n'+'if(u_vectorValue == 1) gl_FragColor = pack(tex.g);\n'+'if(u_vectorValue == 2) gl_FragColor = pack(tex.b);\n'+'if(u_vectorValue == 3) gl_FragColor = pack(tex.a);\n'+'}'+'}\n';this.shader_readpixels=this.gl.createProgram();this.utils.createShader("CLGLREADPIXELS",sourceVertex,sourceFragment,this.shader_readpixels);this.u_offset=this.gl.getUniformLocation(this.shader_readpixels,"u_offset");this.u_vectorValue=this.gl.getUniformLocation(this.shader_readpixels,"u_vectorValue");this.sampler_buffer=this.gl.getUniformLocation(this.shader_readpixels,"sampler_buffer");this.attr_VertexPos=this.gl.getAttribLocation(this.shader_readpixels,"aVertexPosition");this.attr_TextureCoord=this.gl.getAttribLocation(this.shader_readpixels,"aTextureCoord");var sourceVertex=this.precision+'attribute vec3 aVertexPosition;\n'+'attribute vec2 aTextureCoord;\n'+'varying vec2 vTextureCoord;\n'+'void main(void) {\n'+'gl_Position = vec4(aVertexPosition, 1.0);\n'+'vTextureCoord = aTextureCoord;\n'+'}';var sourceFragment=this.precision+'uniform sampler2D sampler_toSave;\n'+'varying vec2 vTextureCoord;\n'+'void main(void) {\n'+'vec4 texture = texture2D(sampler_toSave, vTextureCoord);\n'+'gl_FragColor = texture;'+'}';this.shader_copyTexture=this.gl.createProgram();this.utils.createShader("CLGLCOPYTEXTURE",sourceVertex,sourceFragment,this.shader_copyTexture);this.attr_copyTexture_pos=this.gl.getAttribLocation(this.shader_copyTexture,"aVertexPosition");this.attr_copyTexture_tex=this.gl.getAttribLocation(this.shader_copyTexture,"aTextureCoord");this.sampler_copyTexture_toSave=this.gl.getUniformLocation(this.shader_copyTexture,"sampler_toSave");};WebCLGL.prototype.copy=function(valueToRead,valueToWrite){if(valueToRead instanceof WebCLGLBuffer){this.gl.viewport(0,0,valueToWrite.W,valueToWrite.H);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,valueToWrite.fBuffer);this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,valueToWrite.textureData,0);}else
this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,valueToWrite,0);this.gl.useProgram(this.shader_copyTexture);this.gl.activeTexture(this.gl.TEXTURE0);var toRead=(valueToRead instanceof WebGLTexture)?valueToRead:valueToRead.textureData;this.gl.bindTexture(this.gl.TEXTURE_2D,toRead);this.gl.uniform1i(this.sampler_copyTexture_toSave,0);this.gl.enableVertexAttribArray(this.attr_copyTexture_pos);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer_QUAD);this.gl.vertexAttribPointer(this.attr_copyTexture_pos,3,this.gl.FLOAT,false,0,0);this.gl.enableVertexAttribArray(this.attr_copyTexture_tex);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureBuffer_QUAD);this.gl.vertexAttribPointer(this.attr_copyTexture_tex,3,this.gl.FLOAT,false,0,0);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer_QUAD);this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_SHORT,0);};WebCLGL.prototype.createBuffer=function(length,type,offset,linear){return new WebCLGLBuffer(this.gl,length,type,offset,linear);};WebCLGL.prototype.createKernel=function(source,header){var webclglKernel=new WebCLGLKernel(this.gl,source,header);return webclglKernel;};WebCLGL.prototype.enqueueWriteBuffer=function(buffer,arr,flip){buffer.inData=arr;if(arr instanceof WebGLTexture)buffer.textureData=arr;else{if(flip==false||flip==undefined)
this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,false);else
this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,true);this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);this.gl.bindTexture(this.gl.TEXTURE_2D,buffer.textureData);if(arr instanceof HTMLImageElement){buffer.inData=this.utils.getUint8ArrayFromHTMLImageElement(arr);if(buffer.type=='FLOAT4'){this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.FLOAT,arr);}}else{if(buffer.type=='FLOAT4'){if(arr instanceof Uint8Array){this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,buffer.W,buffer.H,0,this.gl.RGBA,this.gl.FLOAT,new Float32Array(arr));}else if(arr instanceof Float32Array){this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,buffer.W,buffer.H,0,this.gl.RGBA,this.gl.FLOAT,arr);}else{while(arr.length<(buffer.W*buffer.H)*4)arr.push(0.0,0.0,0.0,0.0);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,buffer.W,buffer.H,0,this.gl.RGBA,this.gl.FLOAT,new Float32Array(arr));}}else if(buffer.type=='FLOAT'){var arrayTemp=new Float32Array(buffer.W*buffer.H*4);for(var n=0,f=buffer.W*buffer.H;n<f;n++){var idd=n*4;arrayTemp[idd]=arr[n];arrayTemp[idd+1]=0.0;arrayTemp[idd+2]=0.0;arrayTemp[idd+3]=0.0;}
arr=arrayTemp;this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,buffer.W,buffer.H,0,this.gl.RGBA,this.gl.FLOAT,arr);}}}
if(buffer.linear)this.gl.generateMipmap(this.gl.TEXTURE_2D);};WebCLGL.prototype.enqueueNDRangeKernel=function(kernel,buffer){this.gl.viewport(0,0,buffer.W,buffer.H);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,buffer.fBuffer);this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,buffer.textureData,0);var kp=kernel.kernelPrograms[0];this.gl.useProgram(kp.kernel);var currentTextureUnit=0;for(var n=0,f=kp.samplers.length;n<f;n++){if(currentTextureUnit<16)
this.gl.activeTexture(this.gl["TEXTURE"+currentTextureUnit]);else
this.gl.activeTexture(this.gl["TEXTURE16"]);this.gl.bindTexture(this.gl.TEXTURE_2D,kp.samplers[n].value.textureData);this.gl.uniform1i(kp.samplers[n].location[0],currentTextureUnit);currentTextureUnit++;}
for(var n=0,f=kp.uniforms.length;n<f;n++)
this.gl.uniform1f(kp.uniforms[n].location,kp.uniforms[n].value);this.gl.enableVertexAttribArray(kp.attr_VertexPos);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer_QUAD);this.gl.vertexAttribPointer(kp.attr_VertexPos,3,buffer._supportFormat,false,0,0);this.gl.enableVertexAttribArray(kp.attr_TextureCoord);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureBuffer_QUAD);this.gl.vertexAttribPointer(kp.attr_TextureCoord,3,buffer._supportFormat,false,0,0);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer_QUAD);this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_SHORT,0);};WebCLGL.prototype.enqueueReadBuffer_WebGLTexture=function(buffer){return buffer.textureData;};WebCLGL.prototype.enqueueReadBuffer=function(buffer,item){this.gl.uniform1i(this.u_vectorValue,item);this.gl.uniform1i(this.u_offset,buffer.offset);this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,buffer.textureData);this.gl.uniform1i(this.sampler_buffer,0);this.gl.enableVertexAttribArray(this.attr_VertexPos);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer_QUAD);this.gl.vertexAttribPointer(this.attr_VertexPos,3,buffer._supportFormat,false,0,0);this.gl.enableVertexAttribArray(this.attr_TextureCoord);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureBuffer_QUAD);this.gl.vertexAttribPointer(this.attr_TextureCoord,3,buffer._supportFormat,false,0,0);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer_QUAD);this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_SHORT,0);var arrLength=buffer.length*4;if(item==0){this.gl.readPixels(0,0,buffer.W,buffer.H,this.gl.RGBA,this.gl.UNSIGNED_BYTE,buffer.outArray4Uint8ArrayX);return buffer.outArray4Uint8ArrayX.subarray(0,arrLength);}else if(item==1){this.gl.readPixels(0,0,buffer.W,buffer.H,this.gl.RGBA,this.gl.UNSIGNED_BYTE,buffer.outArray4Uint8ArrayY);return buffer.outArray4Uint8ArrayY.subarray(0,arrLength);}else if(item==2){this.gl.readPixels(0,0,buffer.W,buffer.H,this.gl.RGBA,this.gl.UNSIGNED_BYTE,buffer.outArray4Uint8ArrayZ);return buffer.outArray4Uint8ArrayZ.subarray(0,arrLength);}else if(item==3){this.gl.readPixels(0,0,buffer.W,buffer.H,this.gl.RGBA,this.gl.UNSIGNED_BYTE,buffer.outArray4Uint8ArrayW);return buffer.outArray4Uint8ArrayW.subarray(0,arrLength);}};WebCLGL.prototype.enqueueReadBuffer_Packet4Uint8Array_Float4=function(buffer){if(buffer.type=="FLOAT4"){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);this.gl.viewport(0,0,buffer.W,buffer.H);if(this.e!=undefined){this.e.width=buffer.W;this.e.height=buffer.H;}
this.gl.useProgram(this.shader_readpixels);return[this.enqueueReadBuffer(buffer,0),this.enqueueReadBuffer(buffer,1),this.enqueueReadBuffer(buffer,2),this.enqueueReadBuffer(buffer,3)];}else
return false;};WebCLGL.prototype.enqueueReadBuffer_Float4=function(buffer){if(buffer.type=="FLOAT4"){var packet4Uint8Array=this.enqueueReadBuffer_Packet4Uint8Array_Float4(buffer);var arrayOut=[];for(var n=0,fn=packet4Uint8Array.length;n<fn;n++){var arr=packet4Uint8Array[n];var outArrayFloat32Array=new Float32Array((buffer.W*buffer.H)*4);for(var nb=0,fnb=arr.length/4;nb<fnb;nb++){var idd=nb*4;if(buffer.offset>0)outArrayFloat32Array[nb]=(this.utils.unpack([arr[idd+0]/255,arr[idd+1]/255,arr[idd+2]/255,arr[idd+3]/255])*(buffer.offset*2))-buffer.offset;else outArrayFloat32Array[nb]=(this.utils.unpack([arr[idd+0]/255,arr[idd+1]/255,arr[idd+2]/255,arr[idd+3]/255]));}
arrayOut.push(outArrayFloat32Array);}
return arrayOut;}else
return false;};WebCLGL.prototype.enqueueReadBuffer_Packet4Uint8Array_Float=function(buffer){if(buffer.type=="FLOAT"){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);this.gl.viewport(0,0,buffer.W,buffer.H);if(this.e!=undefined){this.e.width=buffer.W;this.e.height=buffer.H;}
this.gl.useProgram(this.shader_readpixels);return[this.enqueueReadBuffer(buffer,0)];}else
return false;};WebCLGL.prototype.enqueueReadBuffer_Float=function(buffer){if(buffer.type=="FLOAT"){var packet4Uint8Array=this.enqueueReadBuffer_Packet4Uint8Array_Float(buffer);var arrayOut=[];for(var n=0,fn=packet4Uint8Array.length;n<fn;n++){var arr=packet4Uint8Array[n];var outArrayFloat32Array=new Float32Array((buffer.W*buffer.H)*4);for(var nb=0,fnb=arr.length/4;nb<fnb;nb++){var idd=nb*4;if(buffer.offset>0)outArrayFloat32Array[nb]=(this.utils.unpack([arr[idd+0]/255,arr[idd+1]/255,arr[idd+2]/255,arr[idd+3]/255])*(buffer.offset*2))-buffer.offset;else outArrayFloat32Array[nb]=(this.utils.unpack([arr[idd+0]/255,arr[idd+1]/255,arr[idd+2]/255,arr[idd+3]/255]));}
arrayOut.push(outArrayFloat32Array);}
return arrayOut;}else
return false};